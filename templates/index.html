
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Medical AI Assistant</title>
        <link rel="stylesheet" href="/assets/style.css">
        <!-- Add Marked.js for Markdown rendering -->
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
        <script>
            // Function to handle form submission
            async function submitMessage(event) {
                event.preventDefault();
                
                const userInput = document.getElementById('user-input');
                const userMessage = userInput.value.trim();
                
                if (!userMessage) return;
                
                // Get selected model and prompt
                const modelSelect = document.getElementById('model-dropdown');
                const promptSelect = document.getElementById('prompt-dropdown');
                const modelName = modelSelect.value;
                const promptName = promptSelect.value;
                
                // Add user message to chat
                addMessageToChat('user', userMessage);
                
                // Clear input and reset height
                userInput.value = '';
                userInput.style.height = '48px'; // Reset to min-height
                
                // Add temporary assistant message
                const assistantMsgId = 'assistant-msg-' + Date.now();
                addMessageToChat('assistant', 'Generating response...', assistantMsgId);
                
                // Start SSE connection for streaming response
                const eventSource = new EventSource(`/stream?user_message=${encodeURIComponent(userMessage)}&model_name=${encodeURIComponent(modelName)}&prompt_name=${encodeURIComponent(promptName)}`);
                
                let responseContent = '';
                
                eventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    
                    if (data.content) {
                        responseContent = data.content;
                        
                        // Update the assistant message with the current content
                        const assistantMsg = document.getElementById(assistantMsgId);
                        if (assistantMsg) {
                            // Render markdown content
                            assistantMsg.innerHTML = marked.parse(responseContent);
                        }
                        
                        // Scroll to bottom
                        scrollToBottom();
                    }
                    
                    if (data.status === 'complete') {
                        eventSource.close();
                    }
                };
                
                eventSource.onerror = function(error) {
                    console.error('SSE Error:', error);
                    eventSource.close();
                    
                    // Update with error message if no content received
                    if (!responseContent) {
                        const assistantMsg = document.getElementById(assistantMsgId);
                        if (assistantMsg) {
                            assistantMsg.innerHTML = "Error: Failed to generate response. Please try again.";
                        }
                    }
                };
            }
            
            // Function to add a message to the chat
            function addMessageToChat(role, content, id = null) {
                const chatArea = document.getElementById('chat-area');
                
                // Remove margin-bottom from previous last message if it exists
                const lastMessage = chatArea.lastElementChild;
                if (lastMessage) {
                    lastMessage.style.marginBottom = '0';
                }
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}-message`;
                messageDiv.style.width = "100%"; // Ensure full width
                messageDiv.style.marginBottom = '70px'; // Add significant bottom margin to the last message
                
                const contentDiv = document.createElement('div');
                contentDiv.style.width = "100%"; // Ensure content takes full width
                contentDiv.style.maxWidth = "100%"; // Maximum width
                
                if (role === 'user') {
                    // User messages are displayed as plain text
                    contentDiv.textContent = content;
                } else {
                    // Assistant messages are rendered as markdown
                    contentDiv.innerHTML = marked.parse(content);
                }
                
                if (id) {
                    contentDiv.id = id;
                }
                
                messageDiv.appendChild(contentDiv);
                chatArea.appendChild(messageDiv);
                
                scrollToBottom();
            }
            
            // Function to scroll to the bottom of the chat
            function scrollToBottom() {
                const chatArea = document.getElementById('chat-area');
                // Use setTimeout to ensure scrolling happens after DOM updates
                setTimeout(() => {
                    chatArea.scrollTop = chatArea.scrollHeight;
                    
                    // Ensure the last message is fully visible and not covered by the input area
                    const lastMessage = chatArea.lastElementChild;
                    if (lastMessage) {
                        const lastMessageRect = lastMessage.getBoundingClientRect();
                        const chatAreaRect = chatArea.getBoundingClientRect();
                        const inputArea = document.querySelector('.input-area');
                        const inputAreaRect = inputArea.getBoundingClientRect();
                        
                        // Check if the last message is partially covered by the input area
                        if (lastMessageRect.bottom > inputAreaRect.top) {
                            // Adjust scroll to ensure the last message is fully visible
                            chatArea.scrollTop += (lastMessageRect.bottom - inputAreaRect.top + 20); // Add extra padding
                        }
                    }
                }, 10);
            }
            
            // Function to auto-resize textarea as user types
            function autoResizeTextarea(textarea) {
                // Reset height to auto to get the correct scrollHeight
                textarea.style.height = 'auto';
                // Set the height to match the content (scrollHeight)
                textarea.style.height = textarea.scrollHeight + 'px';
            }
            
            // Set focus to input field when page loads and set up auto-resize
            document.addEventListener('DOMContentLoaded', function() {
                const textarea = document.getElementById('user-input');
                textarea.focus();
                
                // Auto-resize textarea as user types
                textarea.addEventListener('input', function() {
                    autoResizeTextarea(this);
                });
                
                // Handle Enter key to submit form (but allow Shift+Enter for new line)
                textarea.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter' && !event.shiftKey) {
                        event.preventDefault(); // Prevent new line
                        document.getElementById('chat-form').dispatchEvent(new Event('submit'));
                    }
                });
                
                // Initialize height
                autoResizeTextarea(textarea);
                
                // No initial message
            });
        </script>
    </head>
    <body style="width: 100%; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;">
        <div class="container" style="max-width: 1200px; width: 100%; margin: 0 auto; display: flex; flex-direction: column; height: 100vh; overflow: hidden;">
            <header>
                <h1>Medical AI Assistant</h1>
            </header>
            
            <main style="width: 100%; flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                <div id="chat-area" class="chat-area" style="width: 100%; flex: 1; overflow-y: auto; padding-bottom: 20px;">
                    <!-- Chat messages will be added here dynamically -->
                </div>
            </main>
            
            <footer class="input-area" style="max-width: 1100px; width: 100%; flex-shrink: 0; position: relative; z-index: 100; box-shadow: 0 -5px 20px rgba(0,0,0,0.1);">
                <div class="dropdown-row">
                    <div class="dash-dropdown-container">
                        <label for="model-dropdown">Model</label>
                        <select id="model-dropdown" class="dropdown">
                            <option value="gemini/gemini-2.0-flash">Gemini 2.0 Flash</option>
                            <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                        </select>
                    </div>
                    
                    <div class="dash-dropdown-container">
                        <label for="prompt-dropdown">System Prompt</label>
                        <select id="prompt-dropdown" class="dropdown">
                            <option value="prompt1">Differential Diagnosis</option>
                            <option value="prompt2">Medical Information</option>
                        </select>
                    </div>
                </div>
                
                <form id="chat-form" onsubmit="submitMessage(event)" class="input-row" style="width: 100%; gap: 30px; display: flex; align-items: flex-start;">
                    <div class="dash-input-container" style="width: 100%; flex: 1;">
                        <textarea id="user-input" placeholder="Enter message..." autocomplete="off" rows="1" style="width: 100%; font-size: 1em; font-family: 'Helvetica', Arial, sans-serif; border-radius: 10px; border: 2px solid #10A37F; resize: none; min-height: 24px; max-height: 120px; overflow-y: auto;"></textarea>
                    </div>
                    
                    <button type="submit" class="send-button" style="align-self: flex-start; border-radius: 10px; border: none; padding: 6px 12px; font-size: 0.9em; height: 32px; min-width: 60px;">Send</button>
                </form>
            </footer>
        </div>
    </body>
    </html>
    