
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Medical AI Assistant</title>
        <link rel="stylesheet" href="/assets/style.css">
        <!-- Add Marked.js for Markdown rendering -->
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
        <script>
            // Function to handle form submission
            async function submitMessage(event) {
                event.preventDefault();
                
                const userInput = document.getElementById('user-input');
                const userMessage = userInput.value.trim();
                
                if (!userMessage) return;
                
                // Get selected model and prompt
                const modelSelect = document.getElementById('model-dropdown');
                const promptSelect = document.getElementById('prompt-dropdown');
                const modelName = modelSelect.value;
                const promptName = promptSelect.value;
                
                // Add user message to chat
                addMessageToChat('user', userMessage);
                
                // Clear input and reset height
                userInput.value = '';
                userInput.style.height = '48px'; // Reset to min-height
                
                // Add temporary assistant message
                const assistantMsgId = 'assistant-msg-' + Date.now();
                addMessageToChat('assistant', 'Generating response...', assistantMsgId);
                
                // Detect Firefox
                const isFirefox = navigator.userAgent.toLowerCase().indexOf('firefox') > -1;
                
                let responseContent = '';
                
                if (isFirefox) {
                    // Use non-streaming approach for Firefox
                    console.log('Using non-streaming approach for Firefox');
                    
                    // Make a POST request to get the complete response
                    fetch('/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_message: userMessage,
                            model_name: modelName,
                            prompt_name: promptName
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        responseContent = data.content;
                        
                        // Update the assistant message with the content
                        const assistantMsg = document.getElementById(assistantMsgId);
                        if (assistantMsg) {
                            // Render markdown content
                            assistantMsg.innerHTML = marked.parse(responseContent);
                        }
                        
                        // Scroll to bottom
                        scrollToBottom();
                    })
                    .catch(error => {
                        console.error('Fetch Error:', error);
                        
                        // Update with error message
                        const assistantMsg = document.getElementById(assistantMsgId);
                        if (assistantMsg) {
                            assistantMsg.innerHTML = "Error: Failed to generate response. Please try again.";
                        }
                    });
                } else {
                    // Use streaming approach for Chrome and other browsers
                    console.log('Using streaming approach for Chrome and other browsers');
                    
                    // Start SSE connection for streaming response
                    const eventSource = new EventSource(`/stream?user_message=${encodeURIComponent(userMessage)}&model_name=${encodeURIComponent(modelName)}&prompt_name=${encodeURIComponent(promptName)}`);
                    
                    let connectionEstablished = false;
                    
                    // Handle successful connection
                    eventSource.onopen = function(event) {
                        console.log('SSE Connection opened');
                        connectionEstablished = true;
                    };
                    
                    // Flag to track if we've already closed the connection
                    let connectionClosed = false;
                    
                    eventSource.onmessage = function(event) {
                        try {
                            const data = JSON.parse(event.data);
                            
                            if (data.content) {
                                responseContent = data.content;
                                
                                // Update the assistant message with the current content
                                const assistantMsg = document.getElementById(assistantMsgId);
                                if (assistantMsg) {
                                    // Render markdown content
                                    assistantMsg.innerHTML = marked.parse(responseContent);
                                }
                                
                                // Scroll to bottom
                                scrollToBottom();
                            }
                            
                            // Check if this is the final message
                            if (data.status === 'complete' && !connectionClosed) {
                                connectionClosed = true;
                                console.log('Closing EventSource connection');
                                eventSource.close();
                            }
                        } catch (parseError) {
                            console.error('Error parsing SSE data:', parseError, event.data);
                            // Continue processing despite parse errors
                        }
                    };
                    
                    // Improved error handling for EventSource
                    eventSource.onerror = function(error) {
                        console.error('SSE Error:', error);
                        
                        // Check if the connection was established before failing
                        if (!connectionEstablished || eventSource.readyState === EventSource.CLOSED) {
                            eventSource.close();
                            
                            // Update with error message if no content received
                            if (!responseContent) {
                                const assistantMsg = document.getElementById(assistantMsgId);
                                if (assistantMsg) {
                                    assistantMsg.innerHTML = "Error: Failed to generate response. Please try again.";
                                }
                            }
                        }
                    };
                }
            }
            
            // Function to add a message to the chat
            function addMessageToChat(role, content, id = null) {
                const chatArea = document.getElementById('chat-area');
                
                // Remove margin-bottom from previous last message if it exists
                const lastMessage = chatArea.lastElementChild;
                if (lastMessage) {
                    lastMessage.style.marginBottom = '0';
                }
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}-message`;
                messageDiv.style.width = "100%"; // Ensure full width
                messageDiv.style.marginBottom = '70px'; // Add significant bottom margin to the last message
                messageDiv.style.padding = '16px 24px'; // Add padding
                
                // Create avatar element
                const avatarDiv = document.createElement('div');
                avatarDiv.style.width = '28px';
                avatarDiv.style.height = '28px';
                avatarDiv.style.borderRadius = '50%';
                avatarDiv.style.display = 'flex';
                avatarDiv.style.alignItems = 'center';
                avatarDiv.style.justifyContent = 'center';
                avatarDiv.style.marginRight = '16px';
                avatarDiv.style.flexShrink = '0';
                avatarDiv.style.fontWeight = 'bold';
                avatarDiv.style.fontSize = '14px';
                avatarDiv.style.color = 'white';
                
                if (role === 'user') {
                    // User avatar styling
                    avatarDiv.style.backgroundColor = '#4361EE';
                    avatarDiv.textContent = 'U';
                } else {
                    // Assistant avatar styling
                    avatarDiv.style.backgroundColor = '#10A37F';
                    avatarDiv.textContent = 'A';
                }
                
                // Create content div
                const contentDiv = document.createElement('div');
                contentDiv.style.width = "100%"; // Ensure content takes full width
                contentDiv.style.maxWidth = "calc(100% - 44px)"; // Maximum width (accounting for avatar)
                contentDiv.style.borderRadius = '12px';
                contentDiv.style.padding = '12px 16px';
                contentDiv.style.boxShadow = '0 1px 2px rgba(0,0,0,0.05)';
                
                if (role === 'user') {
                    // User message styling
                    messageDiv.style.backgroundColor = '#f8f9fa';
                    contentDiv.style.backgroundColor = '#f0f7ff';
                    contentDiv.style.border = '1px solid #e6f0ff';
                    contentDiv.textContent = content;
                } else {
                    // Assistant message styling
                    messageDiv.style.backgroundColor = 'white';
                    contentDiv.style.backgroundColor = 'white';
                    contentDiv.style.border = '1px solid #eaeaea';
                    contentDiv.innerHTML = marked.parse(content);
                }
                
                if (id) {
                    contentDiv.id = id;
                }
                
                messageDiv.appendChild(avatarDiv);
                messageDiv.appendChild(contentDiv);
                chatArea.appendChild(messageDiv);
                
                scrollToBottom();
            }
            
            // Function to scroll to the bottom of the chat
            function scrollToBottom() {
                const chatArea = document.getElementById('chat-area');
                // Use setTimeout to ensure scrolling happens after DOM updates
                setTimeout(() => {
                    chatArea.scrollTop = chatArea.scrollHeight;
                    
                    // Ensure the last message is fully visible and not covered by the input area
                    const lastMessage = chatArea.lastElementChild;
                    if (lastMessage) {
                        const lastMessageRect = lastMessage.getBoundingClientRect();
                        const chatAreaRect = chatArea.getBoundingClientRect();
                        const inputArea = document.querySelector('.input-area');
                        const inputAreaRect = inputArea.getBoundingClientRect();
                        
                        // Check if the last message is partially covered by the input area
                        if (lastMessageRect.bottom > inputAreaRect.top) {
                            // Adjust scroll to ensure the last message is fully visible
                            chatArea.scrollTop += (lastMessageRect.bottom - inputAreaRect.top + 20); // Add extra padding
                        }
                    }
                }, 10);
            }
            
            // Function to auto-resize textarea as user types
            function autoResizeTextarea(textarea) {
                // Reset height to auto to get the correct scrollHeight
                textarea.style.height = 'auto';
                // Set the height to match the content (scrollHeight)
                textarea.style.height = textarea.scrollHeight + 'px';
            }
            
            // Set focus to input field when page loads and set up auto-resize
            document.addEventListener('DOMContentLoaded', function() {
                const textarea = document.getElementById('user-input');
                textarea.focus();
                
                // Auto-resize textarea as user types
                textarea.addEventListener('input', function() {
                    autoResizeTextarea(this);
                });
                
                // Handle Enter key to submit message (but allow Shift+Enter for new line)
                textarea.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter' && !event.shiftKey) {
                        event.preventDefault(); // Prevent new line
                        submitMessage(event); // Call submitMessage directly
                    }
                });
                
                // Add click event listener to the send button
                document.querySelector('.send-button').addEventListener('click', function(event) {
                    submitMessage(event); // Call submitMessage directly
                });
                
                // Initialize height
                autoResizeTextarea(textarea);
                
                // Add welcome message
                addMessageToChat('assistant', 'Hello! I am your medical AI assistant. How can I help you today?');
            });
        </script>
    </head>
    <body style="width: 100%; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; color: #1A1A2E; background-color: #f8f9fa;">
        <div class="container" style="max-width: 1200px; width: 100%; margin: 0 auto; display: flex; flex-direction: column; height: 100vh; overflow: hidden; background-color: white; box-shadow: 0 0 20px rgba(0,0,0,0.05);">
            <header style="padding: 16px 0; border-bottom: 1px solid #eaeaea; background: linear-gradient(to right, #4361EE, #3A0CA3); color: white;">
                <h1 style="text-align: center; margin: 0; font-size: 1.5em; font-weight: 600; letter-spacing: -0.5px;">Medical AI Assistant</h1>
            </header>
            
            <main style="width: 100%; flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                <div id="chat-area" class="chat-area" style="width: 100%; flex: 1; overflow-y: auto; padding-bottom: 20px;">
                    <!-- Chat messages will be added here dynamically -->
                </div>
            </main>
            
            <footer class="input-area" style="max-width: 1100px; width: 100%; flex-shrink: 0; position: relative; z-index: 100; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); background-color: white; padding: 16px 24px; border-top: 1px solid #eaeaea;">
                <div class="dropdown-row" style="display: flex; gap: 16px; margin-bottom: 16px;">
                    <div class="dash-dropdown-container" style="flex: 1;">
                        <label for="model-dropdown" style="display: block; margin-bottom: 6px; font-size: 0.8em; color: #666; font-weight: 500;">Model</label>
                        <select id="model-dropdown" class="dropdown" style="width: 100%; padding: 8px 12px; border-radius: 8px; border: 1px solid #ddd; background-color: #f9f9f9; font-size: 0.9em; color: #333; appearance: none; background-repeat: no-repeat; background-position: right 12px center; cursor: pointer; transition: all 0.2s ease;">
                            <option value="gemini/gemini-2.0-flash">Gemini 2.0 Flash</option>
                            <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                        </select>
                    </div>
                    
                    <div class="dash-dropdown-container" style="flex: 1;">
                        <label for="prompt-dropdown" style="display: block; margin-bottom: 6px; font-size: 0.8em; color: #666; font-weight: 500;">System Prompt</label>
                        <select id="prompt-dropdown" class="dropdown" style="width: 100%; padding: 8px 12px; border-radius: 8px; border: 1px solid #ddd; background-color: #f9f9f9; font-size: 0.9em; color: #333; appearance: none; background-repeat: no-repeat; background-position: right 12px center; cursor: pointer; transition: all 0.2s ease;">
                            <option value="prompt1">Differential Diagnosis</option>
                            <option value="prompt2">Medical Information</option>
                        </select>
                    </div>
                </div>
                
                <!-- Use a div instead of a form to avoid form submission issues in Firefox -->
                <div id="chat-form" class="input-row" style="width: 100%; gap: 16px; display: flex; align-items: flex-start;">
                    <div class="dash-input-container" style="width: 100%; flex: 1; position: relative;">
                        <textarea id="user-input" placeholder="Enter message..." autocomplete="off" rows="1" style="width: 100%; font-size: 1em; font-family: inherit; border-radius: 12px; border: 1px solid #ddd; padding: 12px 16px; resize: none; min-height: 24px; max-height: 120px; overflow-y: auto; box-shadow: 0 2px 6px rgba(0,0,0,0.05); transition: border-color 0.2s ease, box-shadow 0.2s ease; outline: none;"></textarea>
                        <style>
                            #user-input:focus {
                                border-color: #4361EE;
                                box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
                            }
                            .send-button:hover {
                                transform: translateY(-1px);
                                box-shadow: 0 4px 8px rgba(0,0,0,0.15);
                            }
                            .send-button:active {
                                transform: translateY(0);
                                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                            }
                            select.dropdown:hover {
                                border-color: #4361EE;
                            }
                            select.dropdown:focus {
                                border-color: #4361EE;
                                box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
                                outline: none;
                            }
                        </style>
                    </div>
                    
                    <button type="button" class="send-button" style="align-self: flex-start; border-radius: 12px; border: none; padding: 10px 16px; font-size: 0.9em; font-weight: 500; height: 40px; min-width: 80px; background: linear-gradient(to right, #4361EE, #3A0CA3); color: white; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">Send</button>
                </div>
            </footer>
        </div>
    </body>
    </html>
